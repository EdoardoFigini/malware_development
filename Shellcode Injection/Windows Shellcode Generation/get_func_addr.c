#include "../../header.h"

HMODULE get_module(const WCHAR*);
FARPROC get_proc_address(HMODULE, LPCSTR, LPCSTR);

int main(int argc, char** argv){
    HMODULE  hKernel32       = NULL;
    HANDLE   hExitProcess    = NULL;
    HANDLE   hWinExec        = NULL;

    hKernel32 = get_module(L"Kernel32");
    if(hKernel32 == NULL){
        print_err("Failed to get handle to module. Error: 0x%lx", GetLastError());
        return EXIT_FAILURE;
    }

    hExitProcess = (HANDLE)get_proc_address(hKernel32, "ExitProcess", "hExitProcess");
    if(hExitProcess == NULL){
        print_err("Failed to get handle to process. Error: 0x%lx", GetLastError());
        return EXIT_FAILURE;
    }

    hWinExec = (HANDLE)get_proc_address(hKernel32, "WinExec", "hWinExec");
    if(hWinExec == NULL){
        print_err("Failed to get handle to process. Error: 0x%lx", GetLastError());
        return EXIT_FAILURE;
    }

    print_ok("Done");
    return EXIT_SUCCESS;
}

HMODULE get_module(const WCHAR* name) {
  HMODULE hModule = NULL;

  print_info("Getting handle to module \"%S\"", name);

  hModule = GetModuleHandleW(name);

  if(hModule == NULL){
    print_err("Failed getting handle to module \"%S\". Error: 0x%lx", name, GetLastError());
  } else {
    print_ok("Got handle to the module");
    print_info("\\___[\n\t  Module:\t%S\n\t  Address:\t0x%p\n\t]", name, hModule);
  }

  return hModule;
}

FARPROC get_proc_address(HMODULE hModule, LPCSTR lpProcName, LPCSTR lpNewName){
  FARPROC proc = GetProcAddress(hModule, lpProcName);
  if(proc == NULL) {
    print_err("Failed to get handle to %s. Error: 0x%lx", lpProcName, GetLastError());
    return NULL;
  }
  print_ok("Got %s", lpProcName);
  print_info("\\___[\n\t  Original:\t%s\n\t  New:\t\t%s\n\t  Address:\t0x%p\n\t]", lpProcName, lpNewName, proc);
  return proc;
}
